!function(){var i="sketchable";function c(o){var r=[],s=-1,t=this;function n(n){o.handler(function(e,t){n&&0<n.identifier?r[s].strokes=t.strokes.slice():(r.push({image:e.toDataURL(),strokes:t.strokes.slice(),callStack:t.sketch.callStack.slice()}),s++)})}function e(e){if(e.ctrlKey)switch(e.which){case 26:e.shiftKey?t.redo():t.undo();break;case 25:t.redo()}}this.undo=function(){return 0<s&&(s--,this.restore(),o.trigger("mementoundo")),this},this.redo=function(){return s<r.length-1&&(s++,this.restore(),o.trigger("mementoredo")),this},this.reset=function(){return r=[],s=-1,n(),this},this.save=function(e){return n(e),o.trigger("mementosave"),this},this.state=function(){return JSON.parse(JSON.stringify(r[s]))},this.restore=function(e){e=e||r[s];var t=new Image;return t.src=e.image,t.onload=function(){var n,r;n=this,r=e,o.handler(function(e,t){t.sketch.clear(),t.sketch.context.drawImage(n,0,0),t.strokes=r.strokes.slice(),t.sketch.callStack=r.callStack.slice()}),o.trigger("mementochange")},this},this.init=function(){return Event.remove(document,"keypress",e),Event.add(document,"keypress",e),o.trigger("mementoinit"),n(),this},this.destroy=function(){return Event.remove(document,"keypress",e),o.trigger("mementodestroy"),this.reset()}}Sketchable.prototype.plugins.memento=function(t){for(var e={clear:function(e,t){t.memento.reset()},mouseup:function(e,t,n){t.memento.save(n)},destroy:function(e,t){t.memento.destroy()}},n="mouseup clear destroy".split(" "),r=0;r<n.length;r++){var o=n[r];t.decorate(o,e[o],"memento")}deepExtend(t,{memento:{undo:function(){return dataBind(t.elem)[i].memento.undo(),t},redo:function(){return dataBind(t.elem)[i].memento.redo(),t},save:function(){return dataBind(t.elem)[i].memento.save(),t},state:function(){return dataBind(t.elem)[i].memento.state()},restore:function(e){return dataBind(t.elem)[i].memento.restore(e),t}}});var s=dataBind(t.elem)[i];s.memento=new c(t),s.memento.init()}}();